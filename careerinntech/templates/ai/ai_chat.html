{% extends "base.html" %}
{% load static %}

{% block title %}AI Career Chat | CareerInnTech{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/ai_chat.css' %}">
{% endblock %}

{% block content %}

<div class="ai-chat-container">

    <!-- HEADER -->
    <div class="ai-chat-header">
        <h2>CareerInnTech AI Mentor</h2>
        <button id="resetMemoryBtn" class="reset-btn">Reset AI Memory</button>
    </div>

    <!-- CHAT BOX (IMPORTANT FIX) -->
    <div class="chat-box" id="chatBox">
        <div class="ai-message">
            ðŸ‘‹ Hi! Iâ€™m your AI Career Mentor.  
            Ask me anything about careers, skills, exams, or roadmaps.
        </div>
    </div>

    <!-- INPUT -->
    <div class="chat-input">
        <input
            type="text"
            id="userInput"
            placeholder="Type your question here..."
            autocomplete="off"
        />
        <button id="sendBtn">Send</button>
    </div>

</div>

<script>
const chatBox = document.getElementById("chatBox");
const userInput = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");
const resetBtn = document.getElementById("resetMemoryBtn");

function addMessage(text, sender) {
    const div = document.createElement("div");
    div.className = sender === "user" ? "user-message" : "ai-message";
    div.innerText = text;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
}

// ================= SEND MESSAGE =================
sendBtn.onclick = async () => {
    const message = userInput.value.trim();
    if (!message) return;

    addMessage(message, "user");
    userInput.value = "";

    addMessage("Typing...", "ai");

    const response = await fetch("{% url 'openai_ai_chat' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({
            message: message
        })
    });

    const data = await response.json();

    // remove "Typing..."
    chatBox.lastChild.remove();

    if (data.reply) {
        addMessage(data.reply, "ai");
    } else {
        addMessage("âš ï¸ Something went wrong. Try again.", "ai");
    }
};

// ================= RESET MEMORY =================
resetBtn.onclick = async () => {
    if (!confirm("This will erase what AI knows about you. Continue?")) return;

    const response = await fetch("{% url 'reset_ai_memory' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}"
        }
    });

    const data = await response.json();

    if (data.success) {
        chatBox.innerHTML = `
            <div class="ai-message">
                âœ… AI memory reset successfully.  
                Tell me about yourself again to get personalized guidance.
            </div>
        `;
    }
};
</script>

{% endblock %}
